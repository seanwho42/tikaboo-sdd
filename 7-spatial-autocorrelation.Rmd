# 1 - initial data reading/setup

## setup
setting up required libraries
```{r}
library(tidyverse)
library(janitor)
library(ggmap)
library(spdep)
# library(spdep) [TODO: isn't installing]

```
Per <https://mgimond.github.io/Spatial/spatial-autocorrelation-in-r.html> with accompanying lecture notes <https://mgimond.github.io/Spatial/spatial-autocorrelation.html>.

## Reading in data
For spatial autocorrelation, we're going to analyze a few things. One of which is morphology data, which we haven't read in yet. This is in 'data-files/Morphology.csv'
[TODO: make sure this is the most complete version of our morphology data]

```{r}
morphology <- read_csv('data-files/Morphology.csv') %>% clean_names() %>% unique()
head(morphology)
summary(morphology)
```

Now let's join this to our coordinate data. There's need to connect this to genotype data, as this is separate analysis.
```{r}
morph_coords = inner_join(morphology, coords, by=c('tree'='Tree')) %>% select(tree, X, Y, height)
summary(morph_coords)
```
We're left with 1096 trees:

```{r}
ggmap(map_area) +
  # geom_point(geno_coords, mapping=aes(X, Y), size = 0.5) +
  geom_point(morph_coords,
               mapping=aes(x=X, y=Y),
               size=.5)
```

need to make geometric point coordinates for spdep Moran's I functions
```{r}
sf_morph_coords <- morph_coords %>%
  mutate(long=X, lat=Y) %>% 
  st_as_sf(coords = c("X", "Y"), crs=4326)

# 4326 is the code for gps lat/long

```


Now we have to assign our neighbors -- we are doing this distance based -- all within 10m will qualify
```{r}
neighbors <- dnearneigh(x=sf_morph_coords, d1=0, d2=10)
```



Now add weights:
```{r}
weighted <- nb2listw(neighbors, style="W", zero.policy=F)
```


Now we get global Moran's I:
```{r}
MC  <-  moran.mc(sf_morph_coords$height, weighted, nsim=5000, zero.policy=F)
```

```{r}
plot(MC, main="", las=1)
```

```{r}
MC
```
Now local Moran's I:
```{r}
MCi <- localmoran_perm(sf_morph_coords$height, weighted, nsim = 9999)
MCi.df <- as.data.frame(MCi)
MCi.df
```

Now let's add those p values to our data:
```{r}
sf_morph_coords$p <- MCi.df$`Pr(folded) Sim`
summary(sf_morph_coords$p)
```

[todo: Note that the localmoran_perm function generates two different p-values: MCi.df$`Pr(z != E(Ii)) Sim` and MCi.df$`Pr(folded) Sim`. The former is for a two sided test (alternative = "two.sided") and the latter is a “folded” p-value for a one-sided test.]


Now lets map our p values:
```{r}
ggmap(map_area) +
  # geom_point(geno_coords, mapping=aes(X, Y), size = 0.5) +
  geom_point(sf_morph_coords,
               mapping=aes(x=long, y=lat, color=p),
               size=.5)
```


```{r}
ggmap(map_area) +
  # geom_point(geno_coords, mapping=aes(X, Y), size = 0.5) +
  stat_summary_2d(sf_morph_coords,
               mapping=aes(x=long, y=lat, z=height))
```

```{r}
sf_morph_coords %>% summary()
```


```{r}
# need to account for multiple comparisons, this does that
sf_morph_coords$Ii <- hotspot(MCi, Prname="Pr(folded) Sim", cutoff = 0.05, p.adjust = "fdr")
```


```{r}
# Replace NA with "Not significant". This requires that the Ii factor be re-leveled
sf_morph_coords$Ii <- factor(sf_morph_coords$Ii, levels=c("High-High (Tall with tall nearby)","Low-Low (Short with short nearby)", "Low-High (Short with tall nearby)", "High-Low (Tall with short nearby)", "Not significant"))
sf_morph_coords$Ii[is.na(sf_morph_coords$Ii)] <- "Not significant"
```

```{r}
summary(species_sdd)
```
```species_sdd``` only includes the results after the pedigree inference, so we need to join off of the structure results again to make coords with structure

```{r}
species_coords = inner_join(coords, structure, by=join_by('Tree'=='tree')) %>%
  select(Tree, X, Y, percent_brev_ave) %>% 
  mutate(
    species = factor(case_when(
      percent_brev_ave < 0.25 ~ 'y. Jaegeriana',
      percent_brev_ave > 0.75 ~ 'y. Brevifolia',
      .default = 'Hybrid'
    ), levels = c('y. Jaegeriana', 'Hybrid', 'y. Brevifolia'))
  )

spatial_species = inner_join(sf_morph_coords %>% select(-geometry), species_coords, by=c('tree' = 'Tree'))

summary(spatial_species)

```

redefining the map area so it can be a bit bigger
```{r}
morpho_map_lon_center = (max(spatial_species$X)+min(spatial_species$X))/2
morpho_map_lat_center = (max(spatial_species$Y)+min(spatial_species$Y))/2

morpho_map_area = get_googlemap(center = c(lon = morpho_map_lon_center, lat = morpho_map_lat_center),
 zoom = 12,
 maptype = 'terrain')
```


```{r}

dim(spatial_species)
cluster_outlier_palette = c("#E69F00", "#F0E442", "#D55E00", "#CC79A7", "#999999")
ggmap(morpho_map_area) +
  # geom_point(geno_coords, mapping=aes(X, Y), size = 0.5) +
  geom_point(spatial_species,
               mapping=aes(x=long, y=lat, color=Ii),
               size=.7) +
  labs(color = 'Cluster/Outlier type') +
  scale_color_discrete(type=cluster_outlier_palette)

ggmap(morpho_map_area) +
  # geom_point(geno_coords, mapping=aes(X, Y), size = 0.5) +
  geom_point(spatial_species,
               mapping=aes(x=long, y=lat, color=Ii),
               size=.3)+
  facet_wrap(~species, nrow=3)

for (s in unique(spatial_species$species)) {
  s_species = spatial_species %>% filter(species == s)
  # fixing the colors because not all clusters/outlier classifications are represented for each species
  if (s == 'y. Jaegeriana') {
    cluster_outlier_palette = c("#E69F00", "#F0E442", "#D55E00", "#CC79A7", "#999999")
  } else if (s == 'Hybrid') {
    cluster_outlier_palette = c("#E69F00", "#F0E442", "#D55E00", "#999999")
  } else {
    cluster_outlier_palette = c("#E69F00", "#F0E442", "#999999")
  }
  print(s)
  print(s_species)
  print(
    ggmap(morpho_map_area) +
  # geom_point(geno_coords, mapping=aes(X, Y), size = 0.5) +
    geom_point(s_species,
               mapping=aes(x=long, y=lat, color=Ii),
               size=1) +
    facet_wrap(~species, nrow=3) +
    theme_classic() +
    labs(color = 'Cluster/Outlier type') +
    scale_color_discrete(type=cluster_outlier_palette)
  
  )
}
```

```{r}
nw_map_lon_center = -115.51
nw_map_lat_center = 37.48
cluster_outlier_palette = c("#E69F00", "#F0E442", "#D55E00", "#CC79A7", "#999999")
nw_map_area <- get_googlemap(center = c(lon = nw_map_lon_center, lat = nw_map_lat_center),
 zoom = 14,
 maptype = 'terrain')

# zoomed in section for northwest corner

ggmap(nw_map_area) +
  # geom_point(geno_coords, mapping=aes(X, Y), size = 0.5) +
  geom_point(spatial_species,
               mapping=aes(x=long, y=lat, color=Ii),
               size=1) +
    labs(color = 'Cluster/Outlier type') +
  scale_color_discrete(type=cluster_outlier_palette)

```

```{r}
sf_morph_coords %>% 
  group_by(Ii) %>% 
  summarize(mean(height))
```






spatial autocorrelation:
create plots, query trees within each plot to find average genetic distance per plot




